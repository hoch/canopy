<!--
@license
MIT License. Copyright (c) 2015 Hongchan Choi. All rights reserved.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-toast/paper-toast.html">

<!--
This element displays a list of gists as a menu when a valid gist URL is 
provided. The code can be accessed when a menu item clicked.

Example:

  <spiral-gistloader></spiral-gistloader>

@demo
-->
<dom-module id="spiral-gistloader">

  <style>
    :host {
      display: block;
      box-sizing: border-box;
      min-width: 22em;
    }

    .section {
      padding: 0.45em;
    }

    .section-url-input {
      height: 2.25em;
    }

    .section-url-input input {
      font-size: 0.9em;
    }

    .section-gist-list paper-item {
      font-size: 0.9em;
      padding: 0;
      min-height: 2.25em;
    }

    paper-toast {
      overflow: hidden;
      margin: 0;
      font-family: RobotoDraft, 'Helvetica Neue', Helvetica, Arial;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      -webkit-touch-callout: none;
    }
  </style>

  <template>

    <iron-ajax id="gistXHR"
      handle-as="json"
      on-response="_handleXhrResponse"
      on-error="_handleXhrError"></iron-ajax>

    <div class="vertical layout">

      <div class="section">
        <paper-input-container always-float-label
          id="gistInput"
          on-change="_handleGistIdChange"
          class="flex section-url-input">
          <label>Gist URL
            <a href="{{lastSuccessfulGistURL}}" target="_blank">
              <iron-icon icon="link" item-icon></iron-icon>
            </a>
          </label>
          <input is="iron-input" bind-value="{{gistURL}}">
        </paper-input-container>
      </div>

      <div class="section flex">
        <paper-menu class="list section-gist-list">
          <template id="gistList" is="dom-repeat" items="{{gistFiles}}">
            <paper-item on-click="_handleSelectedGist">
              <iron-icon icon="description" item-icon></iron-icon>
              <span>{{item.name}}</span>
            </paper-item>
          </template>
        </paper-menu>
      </div>

      <div class="section">
        <content></content>
      </div>

    </div>

  <paper-toast id="toast"></paper-toast>

  </template>

</dom-module>

<script>

  Polymer({

    is: 'spiral-gistloader',

    properties: {

      gistURL: {
        type: String,
        notify: true
      },

      lastSuccessfulGistURL: {
        type: String,
        value: 'https://gist.github.com/5d2bfc3d7d6ee009ac2c'
      },

      gistURL: String,

      gistFiles: Array,

      onGistLoaded: {
        type: Function,
        value: null
      }

    },

    // Element Lifecycle

    ready: function() {

      // Initial XHR with the default URL.
      this.setGistURL(this.lastSuccessfulGistURL);

    },

    attached: function() {},

    detached: function() {},

    /**
     * Internal: validate, truncate and extract Gist ID.
     * @param {string} url A URL to be processed.
     * @return {string} A clean gist ID.
     */
    _extractGistId: function (url) {
      // Gist ID is shorter than 20 character.
      if (url.length < 20)
        return null;

      // Regex filter.
      var hexDec20 = /[0-9a-f]{20}/;
      var slashPos = -1, poundPos = -1, index = url.length - 1;

      // Find slash and pound.
      while (index--) {
        if (url[index] === '/' && slashPos === -1)
          slashPos = index + 1;
        if (url[index] === '#' && poundPos === -1)
          poundPos = index;
      }

      // If not found, replace with default values. Then truncate.
      if (slashPos === -1)
        slashPos = 0;
      if (poundPos === -1)
        poundPos = url.length;

      // Regex matching and return result.
      var result = hexDec20.exec(url.slice(slashPos, poundPos));

      if (result)
        return result[0];
      else
        return null;
    },

    _displayToastMessage: function (message) {
      this.$.toast.text = message;
      this.$.toast.show();
    },

    /**
     * Brake down the received response and put them into the working buffer.
     * @param {event} event A received XHR response event.
     */
    _handleXhrResponse: function (event) {
      // Successful transaction. Update the last known URL.
      this.set('lastSuccessfulGistURL', this.gistURL);

      this.gistFiles = [];
      var files = event.detail.response.files;
      for (var gist in files) {
        this.push('gistFiles', {
          name: gist,
          code: files[gist].content
        });
      }
    },

    /**
     * Handle the XHR error response.
     * @param {event} event An XHR error response.
     */
    _handleXhrError: function (event) {
      // Failed. Fall back to the last known URL.
      this.set('gistURL', this.lastSuccessfulGistURL);

      // Display error message.
      console.log(event.detail.error.message);
      this._displayToastMessage(event.detail.error.message);
    },

    _handleGistIdChange: function (event) {
      this.setGistURL(event.target.value);
    },

    _handleSelectedGist: function (event) {
      var selectedGist = this.$.gistList.itemForElement(event.target);
      if (this.onGistLoaded) {
        this.onGistLoaded(selectedGist);
      }
    },

    /**
     * Set gist URL (hash) and send XHR request.
     * @param {string} url Gist URL
     */
    setGistURL: function (url) {
      var gistId = this._extractGistId(url);
      if (gistId) {
        var newURL = 'https://gist.github.com/' + gistId;
        this.set('gistURL', newURL);
        this.$.gistXHR.url = 'https://api.github.com/gists/' + gistId;
        this.$.gistXHR.generateRequest();
      }
      else {
        this.set('gistURL', this.lastSuccessfulGistURL);
        this._displayToastMessage('Invalid URL.');
      }
    }

  });

</script>
